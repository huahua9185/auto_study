#!/usr/bin/env python3
"""
æµ‹è¯•è¯¾ç¨‹æ’­æ”¾å¤±è´¥å¤„ç†é€»è¾‘
"""
import sys
from pathlib import Path

# æ·»åŠ æºç è·¯å¾„
sys.path.append(str(Path(__file__).parent / "src"))

def print_section(title):
    """æ‰“å°ç« èŠ‚æ ‡é¢˜"""
    print(f"\n{'='*50}")
    print(f"  {title}")
    print('='*50)

def test_failure_behavior():
    """æµ‹è¯•å¤±è´¥è¡Œä¸ºä¿®æ”¹"""
    print_section("å¤±è´¥å¤„ç†é€»è¾‘æµ‹è¯•")
    
    print("ğŸ“‹ åŸå§‹è¡Œä¸º (å·²åˆ é™¤):")
    print("  âŒ è¯¾ç¨‹æ’­æ”¾å¤±è´¥ â†’ continue â†’ ç»§ç»­ä¸‹ä¸€é—¨è¯¾ç¨‹")
    print("  é—®é¢˜: å¤±è´¥çš„è¯¾ç¨‹è¢«è·³è¿‡ï¼Œå¯èƒ½é—æ¼é‡è¦å†…å®¹")
    print()
    
    print("âœ… æ–°è¡Œä¸º (å·²å®ç°):")
    print("  â›” è¯¾ç¨‹æ’­æ”¾å¤±è´¥ â†’ return False â†’ ç»ˆæ­¢ç¨‹åº")
    print("  ä¼˜ç‚¹: ç¡®ä¿æ¯é—¨è¯¾ç¨‹éƒ½æˆåŠŸå­¦ä¹ ï¼Œä¸ä¼šé—æ¼")
    print()
    
    print("ğŸ”„ å¤±è´¥å¤„ç†æµç¨‹:")
    print("  1. æ£€æµ‹åˆ°è¯¾ç¨‹æ’­æ”¾å¤±è´¥")
    print("  2. è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—")
    print("  3. æ˜¾ç¤ºå¤±è´¥åŸå› å’Œæç¤º")
    print("  4. è®¾ç½® is_running = False")
    print("  5. è¿”å› False ç»ˆæ­¢å­¦ä¹ æµç¨‹")
    print("  6. ç¨‹åºé€€å‡º")

def test_error_messages():
    """æµ‹è¯•é”™è¯¯ä¿¡æ¯å¢å¼º"""
    print_section("é”™è¯¯ä¿¡æ¯å¢å¼º")
    
    error_scenarios = {
        "ç¼ºå°‘URL": {
            "åŸå› ": "è¯¾ç¨‹æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•è·å–å­¦ä¹ é“¾æ¥",
            "æ—¥å¿—": "â›” è¯¾ç¨‹ç¼ºå°‘URL: {course.title}"
        },
        "è§†é¢‘æ£€æµ‹å¤±è´¥": {
            "åŸå› ": "å°è¯•æ‰€æœ‰æ–¹å¼åä»æ— æ³•æ‰¾åˆ°æˆ–å¯åŠ¨è§†é¢‘æ’­æ”¾å™¨",
            "æ—¥å¿—": "â›” ä»ç„¶æœªæ£€æµ‹åˆ°è§†é¢‘æ’­æ”¾å™¨: {course.title}"
        },
        "å¯åŠ¨å­¦ä¹ å¤±è´¥": {
            "åŸå› ": "æ— æ³•å¯åŠ¨è§†é¢‘æ’­æ”¾å™¨æˆ–è§†é¢‘å­¦ä¹ ä¼šè¯",
            "æ—¥å¿—": "â›” å¯åŠ¨è§†é¢‘å­¦ä¹ å¤±è´¥: {course.title}"
        }
    }
    
    for scenario, info in error_scenarios.items():
        print(f"\nåœºæ™¯: {scenario}")
        print(f"  é”™è¯¯æ—¥å¿—: {info['æ—¥å¿—']}")
        print(f"  å¤±è´¥åŸå› : {info['åŸå› ']}")

def test_code_verification():
    """éªŒè¯ä»£ç ä¿®æ”¹"""
    print_section("ä»£ç ä¿®æ”¹éªŒè¯")
    
    main_file = Path("src/auto_study/main.py")
    
    if not main_file.exists():
        print("âŒ æœªæ‰¾åˆ°main.pyæ–‡ä»¶")
        return False
    
    with open(main_file, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # æ£€æŸ¥å…³é”®ä¿®æ”¹
    checks = {
        "ç»ˆæ­¢è€Œéè·³è¿‡": "è¯¾ç¨‹æ’­æ”¾å¤±è´¥æ—¶ç»ˆæ­¢ç¨‹åº" in content,
        "è®¾ç½®è¿è¡ŒçŠ¶æ€": "self.is_running = False" in content,
        "è¿”å›False": "return False" in content and "è¯¾ç¨‹æ’­æ”¾å¤±è´¥" in content,
        "é”™è¯¯å›¾æ ‡": "â›”" in content,
        "å¤±è´¥æç¤º": "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€ç™»å½•çŠ¶æ€" in content
    }
    
    print("ä»£ç æ£€æŸ¥ç»“æœ:")
    all_passed = True
    for check, passed in checks.items():
        status = "âœ…" if passed else "âŒ"
        print(f"  {status} {check}")
        if not passed:
            all_passed = False
    
    return all_passed

def test_execution_flow():
    """æµ‹è¯•æ‰§è¡Œæµç¨‹"""
    print_section("æ‰§è¡Œæµç¨‹ç¤ºä¾‹")
    
    print("ğŸ“š å‡è®¾æœ‰3é—¨è¯¾ç¨‹éœ€è¦å­¦ä¹ :")
    print("  è¯¾ç¨‹1: æ­£å¸¸å­¦ä¹  âœ…")
    print("  è¯¾ç¨‹2: æ’­æ”¾å¤±è´¥ âŒ")
    print("  è¯¾ç¨‹3: ç­‰å¾…å­¦ä¹  â³")
    print()
    
    print("ğŸ”„ åŸæµç¨‹ï¼ˆè·³è¿‡å¤±è´¥ï¼‰:")
    print("  1. å­¦ä¹ è¯¾ç¨‹1 â†’ æˆåŠŸ âœ…")
    print("  2. å­¦ä¹ è¯¾ç¨‹2 â†’ å¤±è´¥ âŒ â†’ è·³è¿‡")
    print("  3. å­¦ä¹ è¯¾ç¨‹3 â†’ æˆåŠŸ âœ…")
    print("  ç»“æœ: è¯¾ç¨‹2è¢«é—æ¼")
    print()
    
    print("â›” æ–°æµç¨‹ï¼ˆå¤±è´¥ç»ˆæ­¢ï¼‰:")
    print("  1. å­¦ä¹ è¯¾ç¨‹1 â†’ æˆåŠŸ âœ…")
    print("  2. å­¦ä¹ è¯¾ç¨‹2 â†’ å¤±è´¥ âŒ â†’ ç»ˆæ­¢")
    print("  3. ç¨‹åºé€€å‡º")
    print("  ç»“æœ: éœ€è¦è§£å†³é—®é¢˜åé‡æ–°è¿è¡Œ")

def test_recovery_strategy():
    """æµ‹è¯•æ¢å¤ç­–ç•¥"""
    print_section("å¤±è´¥åçš„æ¢å¤ç­–ç•¥")
    
    print("ğŸ”§ å½“è¯¾ç¨‹æ’­æ”¾å¤±è´¥æ—¶ï¼Œç”¨æˆ·åº”è¯¥:")
    print()
    print("1. æ£€æŸ¥é—®é¢˜åŸå› :")
    print("   â€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")
    print("   â€¢ ç™»å½•çŠ¶æ€æ˜¯å¦æœ‰æ•ˆ")
    print("   â€¢ è¯¾ç¨‹é¡µé¢æ˜¯å¦å¯ä»¥æ‰‹åŠ¨è®¿é—®")
    print("   â€¢ è§†é¢‘æ’­æ”¾å™¨æ˜¯å¦éœ€è¦ç‰¹æ®Šæƒé™")
    print()
    print("2. è§£å†³é—®é¢˜å:")
    print("   â€¢ é‡æ–°è¿è¡Œç¨‹åº")
    print("   â€¢ ç”±äºè¯¾ç¨‹è¿›åº¦å·²ä¿å­˜ï¼Œä¼šä»å¤±è´¥çš„è¯¾ç¨‹ç»§ç»­")
    print("   â€¢ ä¸ä¼šé‡å¤å­¦ä¹ å·²å®Œæˆçš„è¯¾ç¨‹")
    print()
    print("3. ä¸´æ—¶è·³è¿‡æ–¹æ¡ˆ:")
    print("   â€¢ å¦‚æœç¡®å®æ— æ³•æ’­æ”¾æŸè¯¾ç¨‹")
    print("   â€¢ å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘courses.json")
    print("   â€¢ å°†è¯¥è¯¾ç¨‹çš„progressè®¾ä¸º1.0æ ‡è®°ä¸ºå®Œæˆ")
    print("   â€¢ æˆ–å°†statusæ”¹ä¸º'completed'")

def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("ğŸ” æµ‹è¯•è¯¾ç¨‹æ’­æ”¾å¤±è´¥å¤„ç†é€»è¾‘")
    print("ğŸ“… ä¿®æ”¹å†…å®¹: å¤±è´¥æ—¶ç»ˆæ­¢ç¨‹åºè€Œä¸æ˜¯è·³è¿‡")
    
    # è¿è¡Œæµ‹è¯•
    test_failure_behavior()
    test_error_messages()
    passed = test_code_verification()
    test_execution_flow()
    test_recovery_strategy()
    
    # æ€»ç»“
    print_section("æµ‹è¯•æ€»ç»“")
    
    if passed:
        print("âœ… æ‰€æœ‰ä¿®æ”¹å·²æˆåŠŸå®ç°!")
        print()
        print("ğŸ¯ å…³é”®æ”¹å˜:")
        print("  â€¢ å¤±è´¥æ—¶ç»ˆæ­¢: ç¡®ä¿ä¸é—æ¼ä»»ä½•è¯¾ç¨‹")
        print("  â€¢ è¯¦ç»†é”™è¯¯: æä¾›æ¸…æ™°çš„å¤±è´¥åŸå› ")
        print("  â€¢ ç”¨æˆ·æç¤º: æŒ‡å¯¼å¦‚ä½•è§£å†³é—®é¢˜")
        print("  â€¢ è¿›åº¦ä¿æŠ¤: å·²å®Œæˆçš„è¯¾ç¨‹ä¸ä¼šé‡å¤")
        print()
        print("âš ï¸  æ³¨æ„äº‹é¡¹:")
        print("  â€¢ è¿™ä¸ªä¿®æ”¹ä½¿ç³»ç»Ÿæ›´ä¸¥æ ¼")
        print("  â€¢ ä»»ä½•æ’­æ”¾å¤±è´¥éƒ½ä¼šå¯¼è‡´ç¨‹åºç»ˆæ­¢")
        print("  â€¢ é€‚åˆéœ€è¦ç¡®ä¿æ¯é—¨è¯¾ç¨‹éƒ½å®Œæˆçš„åœºæ™¯")
    else:
        print("âŒ éƒ¨åˆ†ä¿®æ”¹æœªç”Ÿæ•ˆï¼Œè¯·æ£€æŸ¥ä»£ç ")

if __name__ == "__main__":
    main()